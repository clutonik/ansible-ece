---
  - hosts: all
    become: true
    vars_files:
        - vars/initial.yml

    tasks:
        - name: Install Prerequisites
          apt: name=aptitude update_cache=yes state=latest force_apt_get=yes

        # Sudo Group setup
        - name: Create admin group
          group:
            name: admin
            state: present

        - name: Allow admin group to have passwordless sudo
          lineinfile:
            path: /etc/sudoers
            state: present
            regexp: '^%admin'
            line: '%admin ALL=(ALL) NOPASSWD: ALL'
            validate: '/usr/sbin/visudo -cf %s'

        # User and key setup
        - name: Create a new regular user with sudo privileges
          user:
            name: "{{ ssh_user }}"
            state: present
            groups: admin
            append: true
            create_home: true
            shell: /bin/bash

        - name: Setup authorized key for remote user
          authorized_key:
            user: "{{ ssh_user }}"
            state: present
            key: "{{ ssh_local_key }}"

        - name: Disable password authentication for root
          lineinfile:
            path: /etc/ssh/sshd_config
            state: present
            regexp: '^#?PermitRootLogin'
            line: 'PermitRootLogin prohibit-password'